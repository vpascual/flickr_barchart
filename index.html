<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Demo</title>
    <style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.tooltip {
  border:1px solid;
  margin:10px;
  padding: 6px;
  z-index: 10px;
}

.vis {
  position:absolute;
  top: 100px;
  left: 200px;
}

rect {
  stroke : white;
  stroke-width : 1;
}

</style>

</head>
<body>
  
  <p>
    <form id="target" action="">
      Flickr user name: <input type="text" id="usernameTf" value="vpascual"/>
      Init date: <input type="text" id="datepicker" />
      Final date: <input type="text" id="datepicker2" />      
      <select id="combo">
        <option value=0> Hours </option>
        <option value=1 selected="selected"> Days </option>
        <option value=2> Weeks </option>
        <option value=3> Months </option>
      </select>
      <input type="button" value="Go!" id="submitButton"></input>
    </form>
  </p>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script type="text/javascript">
    // definition of global vars
    (function() {  
      window.globalVars = {};
      globalVars.userId = "",
      globalVars.username = "",
      globalVars.initDate = "",
      globalVars.endDate = "",
      globalVars.granularity = 1,
      globalVars.histogram = [],
      globalVars.photos = [];
    }());
    /*var username;
    var userId; // = '12001399@N05';
    var initDate = null;
    var endDate = null;
    var granularity = 1;*/
    </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.v3.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="js/flickr_photos.js" type="text/javascript"></script>
    <script src="js/libs/color-thief.js" type="text/javascript"></script>
    <script src="js/libs/mustache.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <!-- <script src="js/libs/quantize.js" type="text/javascript"></script> 
    Quantize.js seems to be integrated inline in color-thief.js -->
    <script>    

     $(function() {
      $( "#datepicker" ).datepicker({ dateFormat: 'yy-mm-dd' }).val();
    })
     $(function() {
      $( "#datepicker2" ).datepicker({ dateFormat: 'yy-mm-dd' }).val();
    });

    $(function() {  
      $("#submitButton").click(function() {
        // if nothing has changed but the submit button has been pressed, we do nothing
        if (($('#datepicker').val() == "" ||
            $('#datepicker2').val() == "") ||
            (globalVars.initDate == $('#datepicker').val() &&
            globalVars.endDate == $('#datepicker2').val() &&
            globalVars.granularity == parseInt($('#combo').val()) &&
            globalVars.username == $('#usernameTf').val())) {

          console.log("Doing nothing as there haven't been a new selection")
            return;
        }

        if ($('#usernameTf').val() != globalVars.username) {
          console.log("username value is differnt");
          globalVars.username = $('#usernameTf').val();
          getIdFromUserName(globalVars.username, getId);
        } else {
          console.log("username value hasn't changed")
          searchPics();
        }
      });  
    }); 

    function getId(data) {
      if (data.stat == "ok") {
        globalVars.userId = data.user.id;
        searchPics();
      } else {
        alert("Incorrect username");
      }
    }

    function searchPics() {
      // remove the SVG in case we have already created it before    
        d3.select("svg").remove();

        // if the granularity has change, we just recalculate the globalVars.histogram withoug calling Flickr API
        if (globalVars.initDate == $('#datepicker').val() &&
            globalVars.endDate == $('#datepicker2').val() &&
            globalVars.granularity != parseInt($('#combo').val())) {
          
          globalVars.granularity = parseInt($('#combo').val())
          //setGranularity(granularity)
          getDataStructure();
        } else {
            globalVars.initDate = $('#datepicker').val();
            globalVars.endDate = $('#datepicker2').val();          
            globalVars.granularity = parseInt($('#combo').val())
            
            init(globalVars.userId, globalVars.initDate, globalVars.endDate, draw, globalVars.granularity);          
        }
    }

    function draw() {
      console.log("Pictures loaded");
      var dayFormatter = d3.time.format("%x"),
          hourFormatter = d3.time.format("%X");

      var margin = {top: 20, right: 10, bottom: 20, left: 50},
          width = 700 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

      var tooltip = d3.select("body")
        .append("div")
          .attr('class','tooltip')
          .style("position", "absolute")
          .style("visibility", "hidden")
          .style("background-color", "#ffffff");      

      var numOfColumns = globalVars.histogram.length,
          cellWidth = width / numOfColumns,
          maxBarSize = d3.max(globalVars.histogram, function(d) { return d.length; }), // the nums of pictures in the highest bar of the globalVars.histogram
          cellHeight = height / maxBarSize;          

      var svg = d3.select("body").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");            

      for (var col = 0; col<globalVars.histogram.length; col++) {
        array = globalVars.histogram[col];
        for (var row = 0; row<array.length; row++) {
          svg.append("rect")
            .attr("x", function (d) {   return cellWidth * col;   })
            .attr("y", function (d) {   return height - (cellHeight * (row + 1)); })
            .attr("row", row)
            .attr("col", col)
            .attr("width", cellWidth)
            .attr("height", cellHeight)
            
            .style("fill", "steelblue")
              .on("mouseover", function(d) {
                  photo = globalVars.histogram[this.getAttribute("col")][this.getAttribute("row")];
                    tooltip.html(dayFormatter(photo.date) + "<br/>" + hourFormatter(photo.date) + "<br/><img src=\'" + photo.url_sq + "\'></img>");
                    tooltip.style("visibility", "visible");
                    //this.style.cursor = "hand";
                })
              .on("mousemove", function(){
                // d3.event must be used to retrieve pageY and pageX. While this is not needed in Chrome, it is needed in Firefox
                tooltip.style("top", (d3.event.pageY-5)+"px").style("left",(d3.event.pageX+5)+"px");

              })
              .on("mouseout", function(){
                  tooltip.style("visibility", "hidden");
                  //this.style.cursor = "auto";
                })
              .on("click", function(){
                photo = globalVars.histogram[this.getAttribute("col")][this.getAttribute("row")];
                  window.open("http://www.flickr.com/photos/" + globalVars.userId + "/" + photo.id)
                });
            }
      }

      minDate = globalVars.histogram[0][0].date;
      lastArray = globalVars.histogram[globalVars.histogram.length - 1];
      maxDate = lastArray[lastArray.length - 1].date;
      console.log("FirstDate = " + typeof(minDate));
      console.log("lastDate = " + typeof(maxDate));
      console.log("THis is a date: " + typeof(new Date(2013, 11, 11)));
      var xScale = d3.scale.linear()
                     .domain([0, 2])
                     .range([0, width]);

      var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .ticks(3)
                    //.tickFormat(function(d) { return d + " Jun"; })
                    .orient("bottom");


      var yScale = d3.scale.linear()
                     .domain([0, maxBarSize])
                     .range([0, height]);

      var yAxis = d3.svg.axis()
                    .scale(xScale)
                    //.ticks(10)
                    //.tickFormat(function(d) { return d + " Jun"; })
                    .orient("left");
    
      svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
    
      svg.append("g")
        .attr("class", "axis")
        //.attr("transform", "translate(" + width + ", 0)")
        .call(yAxis);
  /*  svg.append("svg:rect")
            .attr("width", width)
            .attr("height", height)
            //.attr("fill", "#fff")
            .style("stroke", "#000");*/
    }


	
    </script>

</body>
</html>