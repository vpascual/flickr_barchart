<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Demo</title>
    <style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.tooltip {
  border:1px solid;
  margin:10px;
  padding: 6px;
  z-index: 10px;
}

.vis {
  position:absolute;
  top: 100px;
  left: 200px;
}

.grid .tick {
    stroke: lightgrey;
    opacity: 0.7;
}
.grid path {
      stroke-width: 0;
}

rect {
  stroke : white;
  stroke-width : 1;
}

</style>

</head>
<body>
  
  <p>
    <form id="target" action="">
      Flickr user name: <input type="text" id="usernameTf" value="vpascual"/>
      Init date: <input type="text" id="datepicker" value="2013-05-01"/>
      Final date: <input type="text" id="datepicker2" value="2013-05-22"/>      
      <select id="combo">
        <option value=0> Hours </option>
        <option value=1 selected="selected"> Days </option>
        <option value=2> Weeks </option>
        <option value=3> Months </option>
      </select>
      <input type="button" value="Go!" id="submitButton"></input>
    </form>
  </p>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <script type="text/javascript">
    // definition of global vars
    (function() {  
      window.globalVars = {};
      globalVars.userId = "",
      globalVars.username = "",
      globalVars.initDate = "",
      globalVars.endDate = "",
      globalVars.granularity = 1,
      globalVars.histogram = [],
      globalVars.photos = [];
    }());
    /*var username;
    var userId; // = '12001399@N05';
    var initDate = null;
    var endDate = null;
    var granularity = 1;*/
    </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.v3.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="js/flickr_photos.js" type="text/javascript"></script>
    <script src="js/libs/color-thief.js" type="text/javascript"></script>
    <script src="js/libs/mustache.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <!-- <script src="js/libs/quantize.js" type="text/javascript"></script> 
    Quantize.js seems to be integrated inline in color-thief.js -->
    <script>    

     $(function() {
      $( "#datepicker" ).datepicker({ dateFormat: 'yy-mm-dd' }).val();
    })
     $(function() {
      $( "#datepicker2" ).datepicker({ dateFormat: 'yy-mm-dd' }).val();
    });

    $(function() {  
      $("#submitButton").click(function() {
        // if nothing has changed but the submit button has been pressed, we do nothing
        if (($('#datepicker').val() == "" ||
            $('#datepicker2').val() == "") ||
            (globalVars.initDate == $('#datepicker').val() &&
            globalVars.endDate == $('#datepicker2').val() &&
            globalVars.granularity == parseInt($('#combo').val()) &&
            globalVars.username == $('#usernameTf').val())) {

          console.log("Doing nothing as there haven't been a new selection")
            return;
        }

        if ($('#usernameTf').val() != globalVars.username) {
          console.log("username value is differnt");
          globalVars.username = $('#usernameTf').val();
          getIdFromUserName(globalVars.username, getId);
        } else {
          console.log("username value hasn't changed")
          searchPics();
        }
      });  
    }); 

    var dateFormat = d3.time.format("%d-%m-%y"); 

    function getId(data) {
      if (data.stat == "ok") {
        globalVars.userId = data.user.id;
        searchPics();
      } else {
        alert("Incorrect username");
      }
    }

    function searchPics() {
      // remove the SVG in case we have already created it before    
        d3.select("svg").remove();

        // if the granularity has change, we just recalculate the globalVars.histogram withoug calling Flickr API
        if (globalVars.initDate == $('#datepicker').val() &&
            globalVars.endDate == $('#datepicker2').val() &&
            globalVars.granularity != parseInt($('#combo').val())) {
          
          globalVars.granularity = parseInt($('#combo').val())
          //setGranularity(granularity)
          getDataStructure();
        } else {
            globalVars.initDate = $('#datepicker').val();
            globalVars.endDate = $('#datepicker2').val();          
            globalVars.granularity = parseInt($('#combo').val())
            
            init(globalVars.userId, globalVars.initDate, globalVars.endDate, draw, globalVars.granularity);          
        }
    }

    function buildXAxis(width, numTicks) {
        var xScale = d3.time.scale()
                     .domain([floorDate(new Date(globalVars.initDate)), floorDate(new Date(globalVars.endDate))])
                     .range([0, width]);

          return d3.svg.axis()
                    .scale(xScale)
                    .ticks(globalVars.histogram.length)
                    //.ticks(d3.time.day, 1)
                    .tickFormat(function(d, i) { 
                      step = Math.floor(globalVars.histogram.length / numTicks);
                      if (i%step == 0) {                        
                        return dateFormat(new Date(d));
                      } else
                        return '';
                    })
                    .orient("bottom");
      } 

      function buildYAxis(height, maxBarSize) {
        var yScale = d3.scale.linear()
                     .domain([0, maxBarSize])
                     .range([height, 0]);     
          return d3.svg.axis()
                    .scale(yScale)
                    //.ticks(d3.time.day)
                    //.tickFormat(function(d) { return d + " Jun"; })
                    .orient("left");
      }  

    function draw() {
      console.log("Pictures loaded");
      var dayFormatter = d3.time.format("%x"),
          hourFormatter = d3.time.format("%X");

      var margin = {top: 20, right: 50, bottom: 20, left: 50},
          width = 700 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

      var tooltip = d3.select("body")
        .append("div")
          .attr('class','tooltip')
          .style("position", "absolute")
          .style("visibility", "hidden")
          .style("background-color", "#ffffff");      

      var numOfColumns = globalVars.histogram.length,
          cellWidth = width / numOfColumns,
          maxBarSize = d3.max(globalVars.histogram, function(d) { return d.length; }), // the num of pictures in the highest bar of the globalVars.histogram
          cellHeight = height / maxBarSize;          

      var svg = d3.select("body").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");     

      // minDate = floorDate(globalVars.histogram[0][0].date);
      // lastArray = globalVars.histogram[globalVars.histogram.length - 1];
      // maxDate = floorDate(lastArray[lastArray.length - 1].date);
      // console.log("FirstDate = " + minDate);
      // console.log("lastDate = " + maxDate);                              
      
      numTicks = (cellWidth < 60) ? Math.floor(width / 60) : globalVars.photos.length;
      console.log("numTicks: " + numTicks);
      svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(-1," + (height + 1) + ")")
        .call(buildXAxis(width, numTicks));
    
      svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(-2, 0)")
        .call(buildYAxis(height, maxBarSize));
    

      /*svg.append("g")         
          .attr("class", "grid")
          .attr("transform", "translate(0," + height + ")")
          .call(buildXAxis()
              .tickSize(-height, 0, 0)
              .tickFormat("")
          );*/

      svg.append("g")         
          .attr("class", "grid")
          .call(buildYAxis(height, maxBarSize)
              .tickSize(-width, 0, 0)
              .tickFormat("")
          );


      // Create a group for each row in the data matrix and
      // translate the group vertically
      var bars = svg.selectAll(".bar")
          .data(globalVars.histogram)
          .enter()
          .append('g')
          .attr('transform', function(d, i) {
              return 'translate(' + cellWidth * i + ')';
          });

      // For each group, create a set of rectangles and bind 
      // them to the inner array (the inner array is already
      // binded to the group)
      bars.selectAll('rect')
          .data(function(d) { 
              console.log(d);
              return d; 
          })
          .enter()
          .append('rect')
              //.attr('x', function(d, i) { return 100 * i; })
              .attr('y', function(d, i) { return height - (cellHeight * (i + 1)); })
              .attr('width', cellWidth)
              .attr('height', cellHeight)
              .style("fill", "steelblue")
              .on("mouseover", function(d) {

                  tooltip.html(dateFormat(d.date) + "<br/>" + hourFormatter(d.date) + "<br/><img src=\'" + d.url_sq + "\'></img>");
                   tooltip.style("visibility", "visible");
                    //this.style.cursor = "hand";
                })
              .on("mousemove", function(){
                // d3.event must be used to retrieve pageY and pageX. While this is not needed in Chrome, it is needed in Firefox
                tooltip.style("top", (d3.event.pageY-5)+"px").style("left",(d3.event.pageX+5)+"px");

              })
              .on("mouseout", function(){
                  tooltip.style("visibility", "hidden");
                  //this.style.cursor = "auto";
                })
              .on("click", function(){
                photo = globalVars.histogram[this.getAttribute("col")][this.getAttribute("row")];
                  window.open("http://www.flickr.com/photos/" + globalVars.userId + "/" + d.id)
                });
            
      }

      function floorDate(date) {
        console.log("floorDate granularity: " + globalVars.granularity)
        switch(globalVars.granularity)
        {
          case 0: // hours          
            return d3.time.hour.floor(date);
          case 1: // days
            return d3.time.day.floor(date);
          case 2: // weeks
            return d3.time.week.floor(date);
          case 3: // months
            return d3.time.month.floor(date);
          default:
            return d3.time.day.floor(date);
        }
      }      
    

	
    </script>

</body>
</html>