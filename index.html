<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Demo</title>
</head>
<body>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>

    <script>
	
	/*
		0 - Hours
		1 - Days
		2 - Weeks
		3 - Months
	*/
	var granularity = 1; 
	var photos = [];
	var currentPhoto = 0; // stores the number of photos that have been processed
	var histogram = []; // each position of this array will contain a sorted array of the pictures that belong to each bin
	
	searchPhotos(1, onPageLoaded);	

	function onPageLoaded(data) {
		console.log(photos)
		console.log(data)
		
		photos = photos.concat(data.photos.photo)

	    console.log("Length: " + photos.length)

	    if (data.photos.page < 2/*data.photos.pages*/)
	    	searchPhotos(data.photos.page + 1, onPageLoaded)
	    else
	    	getPhotosMetadata() 
	}

	function searchPhotos(numPage, callback) {
		$.get(
			    "http://api.flickr.com/services/rest/",
			    {
			    	//oauth_nonce : 89601180, 
			    	method : 'flickr.photos.search',
			    	api_key : '4aa644ee462a328d852a34e4a0fe7855',
			    	user_id : '12001399@N05',
			    	min_taken_date : '2012-12-05',
			    	max_taken_date : '2013-05-22',
			    	page : numPage,
			    	format : 'json',
			    	nojsoncallback : 1
			    }, 
			    callback);
	}

 	function getPhotosMetadata() {
 		if (currentPhoto < photos.length) {
 			photo = photos[currentPhoto];
 			photo.url = "http://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + "_b.jpg";

 			$.get(
			    "http://api.flickr.com/services/rest/",
			    {
			    	//oauth_nonce : 89601180, 
			    	method : 'flickr.photos.getInfo',
			    	api_key : '4aa644ee462a328d852a34e4a0fe7855',
			    	photo_id : photo.id,
			    	secret : photo.secret,
			    	format : 'json',
			    	nojsoncallback : 1
			    }, 
			    function (data, textStatus, oHTTP) {
			    	var splitDate = data.photo.dates.taken.split(' ')
			    	day = splitDate[0].split('-')
			    	hour = splitDate[1].split(':')
			    	date = new Date(day[0], day[1], day[2], hour[0], hour[1], hour[2])
			    	photo.date = date;
			    	//console.log("Taken: " + photo.date)
			    	currentPhoto++;
			    	getPhotosMetadata();
			    });
 		} else {
 			// sorting pictures acording to their date
			photos = photos.sort(function(a,b) { 
			   return ( a.date < b.date ? -1 : (a.date > b.date ? 1 : 0 ) );
			});

			getDataStructure();
 		} 		
 	}

 	function getDataStructure() {
 		var lastDate = -1; 		
 		var currentArray = [];
 		var lastBinIdentifier = getGranularityValue(photos[0].date);

 		for (var i = photos.length - 1; i>-1; i--) {
 			currentPhotoIdentifier = getGranularityValue(photos[i].date)
 			
 			if (currentPhotoIdentifier == lastBinIdentifier)
 				currentArray.push(photos[i]);
 			else {
 				histogram.push(currentArray);
 				lastBinIdentifier = currentPhotoIdentifier;
 				currentArray = [];
 			}	
		}
 	}

 	function getGranularityValue(date) {
 		switch(granularity)
			{
				case 0: // hours
					console.log("Current granularity value: " + date.getHours());
					return date.getHours();
				case 1: // days
					console.log("Current granularity value: " + date.getDay());
					return date.getDay();
				case 2: // weeks
					console.log("Current granularity value: " + getWeekNumber(date));
					return getWeekNumber;
				case 3: // months
					console.log("Current granularity value: " + date.getMonth());
					return date.getMonth();
				default:
					console.log("Return default granularity value: " + date.getDay());
					return date.getDay();
			}
 	}

 	/*
 	*	Code taken from http://stackoverflow.com/questions/6117814/get-week-of-year-in-javascript-like-in-php
 	*/
	function getWeekNumber(d) {
	    // Copy date so don't modify original
	    d = new Date(d);
	    d.setHours(0,0,0);
	    // Set to nearest Thursday: current date + 4 - current day number
	    // Make Sunday's day number 7
	    d.setDate(d.getDate() + 4 - (d.getDay()||7));
	    // Get first day of year
	    var yearStart = new Date(d.getFullYear(),0,1);
	    // Calculate full weeks to nearest Thursday
	    var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7)
	    // Return array of year and week number
	    return [d.getFullYear(), weekNo];
	}
 	/*function getDominantColor(url) {
 		color = getDominantColor(url)
 	}*/

    </script>
</body>
</html>